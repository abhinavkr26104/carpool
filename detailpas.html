<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ride Details with Live Tracking</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* General Styles */
    :root {
      --dark-blue: #1a2a3a;
      --medium-blue: #2c3e50;
      --light-blue: #ecf0f1;
      --accent-blue: #3498db;
      --text-color: #ffffff;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--dark-blue);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    /* Header */
    header {
      background-color: var(--medium-blue);
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: auto;
    }

    .logo {
      display: flex;
      align-items: center;
      font-size: 1.5rem;
      color: var(--accent-blue);
      text-decoration: none;
    }

    .logo svg {
      margin-right: 0.5rem;
    }

    nav a {
      color: var(--light-blue);
      margin-left: 1.5rem;
      text-decoration: none;
      font-size: 1rem;
    }

    nav a:hover {
      color: var(--accent-blue);
    }

    /* Main Content */
    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
      display: flex;
      justify-content: space-between;
      gap: 2rem;
    }

    .ride-details, .map-container {
      flex: 1;
      width: 50%;
    }

    .ride-details {
      max-width: none;
    }

    .host-details {
      background-color: var(--medium-blue);
      border: 1px solid var(--accent-blue);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: var(--accent-blue);
      margin-bottom: 1rem;
      font-size: 1.4rem;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.25rem;
      color: var(--light-blue);
      font-size: 0.9rem;
    }

    input {
      width: 100%;
      padding: 0.5rem;
      background-color: var(--light-blue);
      border: 1px solid var(--accent-blue);
      border-radius: 4px;
      color: var(--dark-blue);
      font-size: 0.9rem;
    }

    button {
      width: 80%;
      padding: 0.75rem;
      margin: auto;
      background-color: var(--accent-blue);
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }

    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    .input {
      display: flex;
      gap: 1rem;
    }

    #map {
      height: 500px;
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .status {
      font-weight: bold;
      margin-top: 1rem;
      color: var(--accent-blue);
      font-size: 1rem;
    }

    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }

      .ride-details, .map-container {
        width: 100%;
      }

      #map {
        height: 300px;
      }
    }

    /* Footer */
    footer {
      background-color: var(--medium-blue);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-color);
      font-size: 0.9rem;
    }

    footer nav {
      display: flex;
    }

    footer nav a {
      color: var(--text-color);
      text-decoration: none;
      margin: 0 1rem;
      font-size: 0.9rem;
      transition: color 0.3s ease;
    }

    footer nav a:hover {
      color: var(--accent-blue);
    }

    footer p {
      margin: 0;
    }

    footer #dark-mode-toggle-container {
      display: none; /* Hide dark mode toggle if not needed */
    }

    /* Footer responsiveness */
    @media (max-width: 768px) {
      footer {
        flex-direction: column;
        text-align: center;
      }

      footer nav {
        margin-top: 0.5rem;
      }
    }
    #emergency-btn {
            background-color: var(--emergency-red);
            color: white;
            font-weight: bold;
            padding: 1rem;
            width: 100%;
            margin-top: 1rem;
            font-size: 1.2rem;
        }

        #emergency-btn:hover {
            background-color: #c0392b;
        }

        #map-placeholder {
            background-color: var(--medium-blue);
            height: 300px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--light-blue);
            font-size: 1.2rem;
            margin-top: 1rem;
        }

        #status {
            background-color: var(--medium-blue);
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        #emergency-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--medium-blue);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--accent-blue);
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }

        .close {
            color: var(--light-blue);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--accent-blue);
        }

  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="#" class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>
        goCorp
      </a>
      <nav>
        <a href="#features">Features</a>
        <a href="#how-it-works">How It Works</a>
        <a href="#">About</a>
        <a href="#">Contact</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="ride-details">
      <div class="host-details">
        <h2>Ride Details</h2>
        <div class="input-group">
          <label for="start-lat">Start Latitude:</label>
          <input type="text" id="start-lat" value="12.9716">
        </div>
        <div class="input-group">
          <label for="start-lng">Start Longitude:</label>
          <input type="text" id="start-lng" value="77.5946">
        </div>
        <div class="input-group">
          <label for="end-lat">End Latitude:</label>
          <input type="text" id="end-lat" value="12.2958">
        </div>
        <div class="input-group">
          <label for="end-lng">End Longitude:</label>
          <input type="text" id="end-lng" value="76.6394">
        </div>
        <div class="input">
          <button id="start-btn">Start Ride</button>
          <button id="reset-view-btn">Reset Map View</button>
        </div>
      </div>
      <div class="status" id="status">Status: Ready to start the ride...</div>
      <button id="emergency-btn">Emergency</button>
    </div>

    <div class="map-container">
      <div id="map"></div>
    </div>
  </main>

  <footer>
    <p>&copy; 2024 goCorp. All rights reserved.</p>
    <nav>
      <a href="#">Privacy Policy</a>
      <a href="#">Terms of Service</a>
      <a href="#">Contact Us</a>
    </nav>
  </footer>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  let travelTime = 0;
  let interval;
  const apiKey = '5b3ce3597851110001cf6248ef865666c8c645ac8e63f7842baf7add'; // Replace with your OpenRouteService API key

  // Initialize the map
  const map = L.map('map').setView([20.5937, 78.9629], 5); // Center on India

  // Set up the OpenStreetMap layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  // Fetch ride details from the database
  fetch('http://localhost:5000/api/ride-details') // Update to your server's URL
    .then(response => response.json())
    .then(data => {
      $("#start-lat").val(data.startLat);
      $("#start-lng").val(data.startLng);
      $("#end-lat").val(data.endLat);
      $("#end-lng").val(data.endLng);
    })
    .catch(error => {
      console.error('Error fetching ride details:', error);
      $("#status").text("Status: Error fetching ride details.");
    });

  $("#start-btn").on("click", function() {
    const startLat = parseFloat($("#start-lat").val());
    const startLng = parseFloat($("#start-lng").val());
    const endLat = parseFloat($("#end-lat").val());
    const endLng = parseFloat($("#end-lng").val());

    if (!startLat || !startLng || !endLat || !endLng) {
      alert("Please enter valid start and end coordinates.");
      return;
    }

    const startLocation = { lat: startLat, lng: startLng };
    const endLocation = { lat: endLat, lng: endLng };

    travelTime = 0;
    $("#status").text("Status: Calculating route...");

    getRouteAndTrack(startLocation, endLocation);
  });

  function getRouteAndTrack(start, end) {
    fetchRoute(start, end, function(routeData) {
      moveAlongRoute(routeData);
    });
  }

  function fetchRoute(start, end, callback) {
    const startCoord = `${start.lng},${start.lat}`;
    const endCoord = `${end.lng},${end.lat}`;

    fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=${startCoord}&end=${endCoord}`)
      .then(response => response.json())
      .then(data => {
        if (data.features && data.features.length > 0) {
          const route = data.features[0].geometry.coordinates;
          callback(route);
        } else {
          console.error('Route not found.');
          $("#status").text("Status: Route not found.");
        }
      })
      .catch(error => {
        console.error('Error:', error);
        $("#status").text("Status: Error fetching route.");
      });
  }

  let routeBounds;

  function moveAlongRoute(route) {
    let routeIndex = 0;
    let polyline = L.polyline([], { color: '#3498db', weight: 5 }).addTo(map);

    // Calculate the bounds of the route
    routeBounds = L.latLngBounds(route.map(coord => [coord[1], coord[0]]));
    window.routeBounds = routeBounds; //Added this line

    // Fit the map to the route bounds with minimal padding
    map.fitBounds(routeBounds.pad(0.05));
    let currentZoom = map.getZoom();
    map.setZoom(Math.min(currentZoom + 4, 18)); // Increase zoom by 4 levels, max zoom 18

    interval = setInterval(() => {
      travelTime += 1;

      if (routeIndex < route.length) {
        const currentLocation = {
          lng: route[routeIndex][0],
          lat: route[routeIndex][1]
        };

        routeIndex++;
        polyline.addLatLng([currentLocation.lat, currentLocation.lng]);
        map.panTo([currentLocation.lat, currentLocation.lng]);

        updateETA(route.length - routeIndex);
      } else {
        clearInterval(interval);
        $("#status").text("Status: Arrived at destination!");
      }
    }, 1000); // Update every second
  }

  function resetMapView() {
    if (window.routeBounds) {
      map.fitBounds(window.routeBounds.pad(0.05));
      let currentZoom = map.getZoom();
      map.setZoom(Math.min(currentZoom + 4, 18));
    }
  }

  function updateETA(remainingPoints) {
    const remainingTime = Math.max(0, remainingPoints * 1); // 1 second per point, for simplicity
    $("#status").text(`Status: On the way... ETA: ${remainingTime} seconds.`);
  }

  $("#reset-view-btn").on("click", resetMapView);
  let currentLocation = null;

function updateCurrentLocation(location) {
  currentLocation = location;
}

$("#emergency-btn").on("click", function() {
  if (currentLocation) {
    $("#emergency-location").text(`Latitude: ${currentLocation.lat.toFixed(6)}, Longitude: ${currentLocation.lng.toFixed(6)}`);
  } else {
    $("#emergency-location").text("Location not available");
  }
  $("#emergency-modal").css("display", "block");
  
  // Simulate contacting emergency services
  console.log("Emergency services contacted with location:", currentLocation);
});

$(".close-modal").on("click", function() {
  $("#emergency-modal").css("display", "none");
});

// Modify the moveAlongRoute function to update current location
function moveAlongRoute(route) {
  let routeIndex = 0;
  let polyline = L.polyline([], { color: '#3498db', weight: 5 }).addTo(map);

  routeBounds = L.latLngBounds(route.map(coord => [coord[1], coord[0]]));
  window.routeBounds = routeBounds;

  map.fitBounds(routeBounds.pad(0.05));
  let currentZoom = map.getZoom();
  map.setZoom(Math.min(currentZoom + 4, 18));

  interval = setInterval(() => {
    travelTime += 1;

    if (routeIndex < route.length) {
      const currentLocation = {
        lng: route[routeIndex][0],
        lat: route[routeIndex][1]
      };

      updateCurrentLocation(currentLocation); // Update current location

      routeIndex++;
      polyline.addLatLng([currentLocation.lat, currentLocation.lng]);
      map.panTo([currentLocation.lat, currentLocation.lng]);

      updateETA(route.length - routeIndex);
    } else {
      clearInterval(interval);
      $("#status").text("Status: Arrived at destination!");
    }
  }, 1000);
}
</script>
</body>
</html>
